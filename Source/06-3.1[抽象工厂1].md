![封面](.\pic\封面.png)

# 1、意图

在系统初始化阶段，选择一个“平台实现”， 之后系统中所有相关模块都必须从这个平台创建，且彼此匹配。

注意三点：

1. **一系列对象（不是一个）**
2. **相关 / 依赖（必须能一起工作）**
3. **选择发生在“创建阶段”，不是使用阶段**

# 2、动机

## 2.1 原意

在 GoF 写书的年代（1995）：

*`GoF是“四人组”（Gang of Four）的英文缩写，指代软件工程著作《Design Patterns: Elements of Reusable Object-Oriented Software》的四位作者埃里希·伽玛（Erich Gamma）、理查德·海尔姆（Richard Helm）、拉尔夫·约翰逊（Ralph Johnson）和约翰·弗利赛迪斯（John Vlissides）。`*

- Windows / Motif / MacOS UI
- **控件长得不一样**
- 但“按钮 / 滚动条 / 窗口”这些概念是一样的
- 用户代码希望 **一次切换平台，整体换外观**

GUI 是一个**极佳的“产品族”例子**：

```
Windows 风格
 ├─ Button
 ├─ Scrollbar
 └─ Menu

Motif 风格
 ├─ Button
 ├─ Scrollbar
 └─ Menu
```

如何保证 Button / Scrollbar / Menu 来自同一个 UI 风格？

## 2.2 嵌入式适配

不是 RTOS，也不是驱动函数，而是：

> **平台 / 芯片 / BSP**

因为它们同样具备三个特征：

1. 提供一组功能等价的接口
2. 实现细节强相关
3. 必须整体切换

| GoF GUI    | 嵌入式等价      |
| ---------- | --------------- |
| Button     | UART            |
| Scrollbar  | GPIO            |
| Menu       | SPI             |
| UI Toolkit | MCU / SoC / BSP |



你觉得抽象工厂是怎么做的？stm32hal库？


### Step 1：系统要支持多个平台

例如：

- STM32Fx
- GD32?

**业务逻辑完全一样：**

```
log_print("hello");
led_on();
```

------

### Step 2：所谓的实现？

```
#ifdef STM32Fx
    stm32_uart_send(...);
    stm32_gpio_set(...);
#elif defined GD32
    gd32_uart_send(...);
    gd32_gpio_set(...);
#endif
```

GoF 在 GUI 里用的是：

```
if (windows)
    new WinButton;
else
    new MotifButton;
```

### Step 3：问题暴露